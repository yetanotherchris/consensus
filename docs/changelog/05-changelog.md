# Changelog 05 - ConsensusController Implementation

## Original Prompt
Can you implement the GetHtml and GetJobStatus methods of the controller in the API

## Follow-up Questions and Answers

**Q1:** For GetHtml: Should I read the HTML file from the proper location based on the configured output directory?
**A:** Yes and keep the job existence check

**Q2:** For GetJobStatus: The method appears already implemented. Do you want me to review and potentially improve it?
**A:** Yes review + improve it. Jobs should time out similarly to the orchestrator

**Q3:** Output directory resolution: Should I inject the output directory path into the controller?
**A:** Yes

**Q4:** Error handling: For GetHtml, if a job is finished but the file doesn't exist, should I return a specific error message?
**A:** 404

## Changes Made

### New Files Created

#### `src/Consensus.Api/Services/IOutputFileService.cs`
- Interface for reading output files (HTML and markdown) generated by consensus jobs
- Methods: `ReadHtmlAsync`, `ReadMarkdownAsync`, `HtmlExists`, `MarkdownExists`

#### `src/Consensus.Api/Services/OutputFileService.cs`
- Implementation of `IOutputFileService`
- Reads files from configured output directory path: `{outputDirectory}/output/responses/`
- HTML files: `output-{runId}.html`
- Markdown files: `consensus-{runId}.md`
- Proper error handling and logging for missing files

### Modified Files

#### `src/Consensus.Api/Models/JobStatusModel.cs`
- Added `Timeout` status to `JobStatus` enum
- Allows tracking of jobs that exceed expected execution time

#### `src/Consensus.Api/Jobs/Scheduling/QuartzJobScheduler.cs`
- Added `IConfiguration` injection to access `AgentTimeoutSeconds` configuration
- Enhanced `GetJobStatusAsync` method with timeout detection logic
- Calculates expected max duration based on: `(modelCount * agentTimeoutSeconds) + (agentTimeoutSeconds * 2)`
- Sets status to `Timeout` when job exceeds expected duration without finishing
- Improved status determination logic for better accuracy

#### `src/Consensus.Api/ConsensusWebAppBuilder.cs`
- Registered `IOutputFileService` in DI container
- Service is configured with output directory path from configuration

#### `src/Consensus.Api/Controllers/ConsensusController.cs`
- Added `IOutputFileService` dependency injection
- **GetHtml method**: Now reads actual HTML files from output directory using `IOutputFileService`
  - Checks if job exists first
  - Returns 404 with descriptive message if file not found
- **GetMarkdown method**: Updated to use `IOutputFileService` instead of stubbed data
  - Same error handling as GetHtml
- **GetJobStatus method**: Already functional, now benefits from improved timeout detection in `QuartzJobScheduler`

## Implementation Details

### Timeout Detection
Jobs are considered timed out when:
1. Job has started (`startedAt` is set)
2. Job hasn't finished (`finishedAt` is null)
3. Running duration exceeds: `(6 models × agentTimeoutSeconds) + (2 × agentTimeoutSeconds for synthesis)`
4. Default timeout per agent: 120 seconds, configurable via `Consensus:AgentTimeoutSeconds`

### File Path Resolution
Output files follow the naming convention established by `FileOutputWriter`:
- Base path: `{configuredOutputDirectory}/output/responses/`
- HTML: `output-{runId}.html`
- Markdown: `consensus-{runId}.md`

### Error Handling
- Job not found: 404 with message "ID '{runId}' not found"
- File not found: 404 with message indicating output not found and job may still be running or failed
- All file operations wrapped in try-catch with proper logging

## Testing
- Project builds successfully with no errors
- All new services properly registered in DI container
- Type-safe implementation with proper async/await patterns
